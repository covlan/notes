<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统设置 - 笔记平台</title>
    <meta name="description" content="一个简单易用的个人笔记管理平台">
    <meta name="keywords" content="笔记,Markdown,知识管理">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/sidebar-menu.css">
    <link rel="stylesheet" href="css/content-header.css">
    <link rel="stylesheet" href="css/settings.css">
    <!-- 引入API组件 -->
    <script src="./component/api.js"></script>
    <script src="./component/commpush.js"></script>
    <!-- 引入站点信息加载脚本 -->
    <script src="component/site-info.js"></script>
    <!-- 引入侧边栏菜单组件 -->
    <script src="component/sidebar-menu.js"></script>
    <!-- 引入确认对话框组件 -->
    <script src="component/confirm-dialog.js"></script>
    <!-- 引入提示消息组件 -->
    <script src="component/toast-message.js"></script>
    <!-- 引入内容头部组件 -->
    <script src="component/content-header.js"></script>
    <style>
        /* 设置页面特定样式 */
        .settings-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .settings-sidebar {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .settings-menu-item {
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-menu-item:hover {
            background-color: var(--sidebar-hover);
        }

        .settings-menu-item.active {
            background-color: var(--primary-color);
            color: white;
        }

        .settings-menu-item i {
            width: 20px;
            text-align: center;
        }

        .settings-content {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            box-shadow: var(--card-shadow);
        }

        .settings-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .settings-section.active {
            display: block;
        }

        .settings-section h2 {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 16px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 107, 255, 0.2);
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin-top: 16px;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--sidebar-hover);
            color: var(--text-color);
        }

        .btn-row {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .test-connection-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }

        .success {
            background-color: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .error {
            background-color: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* 导入笔记相关样式 */
        .import-dropzone {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background-color: var(--bg-color);
            transition: all 0.3s ease;
        }

        .import-dropzone.drag-over {
            border-color: var(--primary-color);
            background-color: rgba(26, 115, 232, 0.05);
        }

        .dark-mode .import-dropzone.drag-over {
            background-color: rgba(66, 133, 244, 0.1);
        }

        .import-dropzone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .import-dropzone-content i {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .import-dropzone-content p {
            margin: 10px 0;
            font-size: 16px;
        }

        .import-note {
            font-size: 14px !important;
            color: var(--text-muted);
        }

        .import-file-list {
            text-align: left;
            margin-top: 20px;
        }

        .import-file-list ul {
            list-style: none;
            padding: 0;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            margin-left: 15px;
            color: var(--text-muted);
            font-size: 14px;
        }

        .file-remove {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            margin-left: 10px;
            opacity: 0.7;
        }

        .file-remove:hover {
            opacity: 1;
            color: var(--danger-color);
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: var(--bg-color);
            border-radius: 5px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .import-results {
            text-align: left;
        }

        .import-result-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .import-result-item i {
            margin-right: 10px;
        }

        .import-result-item.success {
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        .import-result-item.error {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        .dark-mode .import-result-item.success {
            background-color: rgba(40, 167, 69, 0.2);
            border-color: rgba(40, 167, 69, 0.3);
        }

        .dark-mode .import-result-item.error {
            background-color: rgba(220, 53, 69, 0.2);
            border-color: rgba(220, 53, 69, 0.3);
        }

        #import-errors {
            list-style: disc;
            margin-left: 20px;
            color: #dc3545;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .settings-container {
                grid-template-columns: 1fr;
            }

            .settings-sidebar {
                display: flex;
                overflow-x: auto;
                padding: 10px;
            }

            .settings-menu-item {
                margin: 0 5px;
                white-space: nowrap;
            }
        }
    </style>
</head>

<body>
    <!-- 侧边栏 -->
    <div id="sidebar"></div>

    <!-- 主题切换按钮 -->
    <div class="theme-toggle" id="themeToggle">
        <div class="theme-toggle-circle"></div>
    </div>

    <!-- 主内容区域 -->
    <div class="main-content" id="mainContent">
        <div class="content-header" id="contentHeader">
            <!-- 将由ContentHeader组件动态生成 -->
        </div>

        <div class="settings-container">
            <!-- 设置侧边栏 -->
            <div class="settings-sidebar">
                <div class="settings-menu-item active" data-section="site-info">
                    <i class="fas fa-info-circle"></i>
                    <span>站点信息</span>
                </div>

                <div class="settings-menu-item" data-section="security">
                    <i class="fas fa-shield-alt"></i>
                    <span>安全设置</span>
                </div>
                <div class="settings-menu-item" data-section="backup">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>备份与恢复</span>
                </div>
                <div class="settings-menu-item" data-section="export">
                    <i class="fas fa-exchange-alt"></i>
                    <span>导入导出</span>
                </div>
                <div class="settings-menu-item" data-section="advanced">
                    <i class="fas fa-sliders-h"></i>
                    <span>高级设置</span>
                </div>
            </div>

            <!-- 设置内容区 -->
            <div class="settings-content">
                <!-- 站点信息设置 -->
                <div class="settings-section active" id="site-info">
                    <h2>站点信息设置</h2>
                    <div class="form-group">
                        <label for="site-title">网站标题</label>
                        <input type="text" id="site-title" class="form-control" placeholder="在浏览器标签中显示的名称" value="笔记平台">
                    </div>
                    <div class="form-group">
                        <label for="site-description">网站描述</label>
                        <textarea id="site-description" class="form-control" rows="3"
                            placeholder="简短的网站描述">一个简单易用的个人笔记管理平台</textarea>
                    </div>
                    <div class="form-group">
                        <label for="site-keywords">网站关键词</label>
                        <input type="text" id="site-keywords" class="form-control" placeholder="关键词之间用逗号分隔"
                            value="笔记,Markdown,知识管理">
                    </div>
                    <div class="form-group">
                        <label for="site-logo">网站Logo</label>
                        <input type="file" id="site-logo" class="form-control">
                        <p style="margin-top: 8px; color: var(--text-color); opacity: 0.7; font-size: 14px;">
                            推荐上传PNG格式，尺寸不小于200x200像素
                        </p>
                    </div>
                    <div class="form-group">
                        <label for="footer-text">页脚版权文本</label>
                        <input type="text" id="footer-text" class="form-control" value="© 2023 笔记平台 - 版权所有">
                    </div>
                    <div class="btn-row">
                        <button class="btn" id="save-site-info">保存设置</button>
                    </div>
                </div>

                <!-- 安全设置 -->
                <div class="settings-section" id="security">
                    <h2>安全设置</h2>
                    <div class="form-group">
                        <label for="allow-registration">允许新用户注册</label>
                        <select id="allow-registration" class="form-control">
                            <option value="1">允许</option>
                            <option value="0">禁止</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="session-lifetime">会话有效期</label>
                        <select id="session-lifetime" class="form-control">
                            <option value="1">1小时</option>
                            <option value="8">8小时</option>
                            <option value="24" selected>1天</option>
                            <option value="168">7天</option>
                            <option value="720">30天</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="password-min-length">密码最小长度</label>
                        <input type="number" id="password-min-length" class="form-control" value="8" min="6" max="20">
                    </div>
                    <div class="form-group">
                        <label for="login-attempt-limit">登录失败尝试次数限制</label>
                        <input type="number" id="login-attempt-limit" class="form-control" value="5" min="3" max="10">
                    </div>
                    <div class="form-group">
                        <label for="lockout-duration">账户锁定时间（分钟）</label>
                        <input type="number" id="lockout-duration" class="form-control" value="30" min="5">
                    </div>
                    <div class="btn-row">
                        <button class="btn" id="save-security-settings">保存设置</button>
                    </div>
                </div>

                <!-- 备份设置 -->
                <div class="settings-section" id="backup">
                    <h2>备份与恢复</h2>
                    <div class="form-group">
                        <label for="auto-backup">自动备份</label>
                        <select id="auto-backup" class="form-control">
                            <option value="0">禁用</option>
                            <option value="1">每天</option>
                            <option value="7" selected>每周</option>
                            <option value="30">每月</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="backup-retention">保留备份数量</label>
                        <input type="number" id="backup-retention" class="form-control" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label for="backup-location">备份存储位置</label>
                        <input type="text" id="backup-location" class="form-control" value="./backups">
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 15px;">手动备份</h3>
                    <p style="margin-bottom: 15px;">手动创建笔记数据备份，将包含所有笔记、标签、分类等信息。</p>
                    <div class="btn-row" style="justify-content: flex-start;">
                        <button class="btn" id="manual-backup">创建备份</button>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 15px;">恢复备份</h3>
                    <div class="form-group">
                        <label for="restore-file">选择备份文件</label>
                        <input type="file" id="restore-file" class="form-control">
                    </div>
                    <div class="btn-row" style="justify-content: flex-start;">
                        <button class="btn btn-secondary" id="restore-backup">恢复备份</button>
                    </div>

                    <div class="btn-row" style="margin-top: 30px;">
                        <button class="btn" id="save-backup-settings">保存设置</button>
                    </div>
                </div>

                <!-- 导入导出设置 -->
                <div class="settings-section" id="export">
                    <h2>导入导出</h2>
                    <!-- 导入笔记区域 -->
                    <h3 style="margin-bottom: 15px;">导入笔记</h3>
                    <div class="form-group">
                        <div id="import-dropzone" class="import-dropzone">
                            <div class="import-dropzone-content">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>将笔记文件拖放到此处，或点击选择文件</p>
                                <p class="import-note">支持 .md 格式的文件，最多可同时上传20个文件<br>
                                第一行#标题，将作为笔记标题，否则将默认使用文件名</p>
                                <input type="file" id="import-file-input" multiple accept=".md" style="display: none;">
                                <button class="btn" id="import-select-btn">选择文件</button>
                            </div>
                            <div id="import-file-list" class="import-file-list" style="display: none;">
                                <h4>待上传文件：</h4>
                                <ul id="import-files"></ul>
                                <div class="btn-row" style="margin-top: 15px;">
                                    <button class="btn btn-secondary" id="import-clear-btn">清空</button>
                                    <button class="btn" id="import-upload-btn">开始导入</button>
                                </div>
                            </div>
                            <div id="import-progress" class="import-progress" style="display: none;">
                                <div class="progress-bar-container">
                                    <div id="import-progress-bar" class="progress-bar"></div>
                                </div>
                                <div id="import-status">准备导入...</div>
                            </div>
                            <div id="import-results" class="import-results" style="display: none;">
                                <h4>导入结果：</h4>
                                <div id="import-success-count" class="import-result-item success">
                                    <i class="fas fa-check-circle"></i>
                                    <span>成功：0个笔记</span>
                                </div>
                                <div id="import-failed-count" class="import-result-item error">
                                    <i class="fas fa-times-circle"></i>
                                    <span>失败：0个笔记</span>
                                </div>
                                <div id="import-error-list" style="margin-top: 10px; display: none;">
                                    <h5>错误详情：</h5>
                                    <ul id="import-errors"></ul>
                                </div>
                                <button class="btn" id="import-done-btn" style="margin-top: 15px;">完成</button>
                            </div>
                        </div>
                    </div>

                    <div style="margin: 30px 0; border-top: 1px solid var(--border-color);"></div>

                    <!-- 导出笔记区域 -->
                    <h3 style="margin-bottom: 15px;">导出笔记</h3>
                    <p style="margin-bottom: 15px;">将笔记导出为Markdown格式的压缩文件，方便备份或迁移到其他平台。<br>
                        笔记标题将作为内容第一行，并以 #标题 格式显示</p>

                    <div class="btn-row" style="justify-content: flex-start; margin-top: 10px;">
                        <button class="btn" id="export-notes">导出笔记</button>
                        <span id="export-status" style="margin-left: 10px; display: none;"></span>
                    </div>
                </div>

                <!-- 高级设置 -->
                <div class="settings-section" id="advanced">
                    <h2>高级设置</h2>
                    <div class="form-group">
                        <label for="editor-default-mode">编辑器默认模式</label>
                        <select id="editor-default-mode" class="form-control">
                            <option value="wysiwyg">所见即所得</option>
                            <option value="markdown">Markdown</option>
                            <option value="split">分屏模式</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="upload-max-size">上传文件大小限制 (MB)</label>
                        <input type="number" id="upload-max-size" class="form-control" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label for="cache-lifetime">缓存有效期（分钟）</label>
                        <input type="number" id="cache-lifetime" class="form-control" value="60" min="5">
                    </div>
                    <div class="form-group">
                        <label for="language">系统语言</label>
                        <select id="language" class="form-control">
                            <option value="zh-CN" selected>简体中文</option>
                            <option value="en-US">English (US)</option>
                            <option value="ja-JP">日本語</option>
                        </select>
                    </div>

                    <div class="btn-row" style="margin-top: 30px;">
                        <button class="btn" id="save-advanced-settings">保存设置</button>
                    </div>
                    <div class="form-group">
                        <label for="timezone">时区设置</label>
                        <select id="timezone" class="form-control">
                            <option value="Asia/Shanghai" selected>中国标准时间 (GMT+8)</option>
                            <option value="America/New_York">美国东部时间</option>
                            <option value="Europe/London">格林威治标准时间</option>
                            <option value="Asia/Tokyo">日本标准时间</option>
                            <option value="Australia/Sydney">澳大利亚东部时间</option>
                        </select>
                    </div>
                    <div class="btn-row">
                        <button class="btn" id="save-advanced-settings">保存设置</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 确保CommPush实例已初始化
            if (!window.commpush) {
                window.commpush = new CommPush();
            }

            // 获取API客户端实例
            const apiClient = window.commpush || window.api;
            
            // 初始化变量，避免重复计算
            let siteSettingsLoaded = false;
            let securitySettingsLoaded = false;
            let backupSettingsLoaded = false;
            let advancedSettingsLoaded = false;

            // 初始化侧边栏菜单
            const sidebarMenu = new SidebarMenu({
                containerId: 'sidebar',
                logoText: '笔记平台',
                logoIcon: 'fas fa-book',
                menuItems: [
                    { id: 'home', text: '我的笔记', icon: 'fas fa-home', page: 'dashboard.html' },
                    { id: 'starred', text: '收藏笔记', icon: 'fas fa-star', page: 'starred-notes.html' },
                    { id: 'categories', text: '笔记分类', icon: 'fas fa-folder', page: 'note-categories.html' },
                    { id: 'tags', text: '标签管理', icon: 'fas fa-tags', page: 'tags.html' },
                    { id: 'shared', text: '分享笔记', icon: 'fas fa-share-alt', page: 'note-share.html' },
                    { id: 'trash', text: '回收站', icon: 'fas fa-trash', page: 'trash.html' }
                ],
                autoNavigate: true
            });

            // 初始化内容头部
            const contentHeader = new ContentHeader({
                containerId: 'contentHeader',
                title: '系统设置',
                icon: 'fas fa-cog',
                showViewToggle: false,
                showRefreshButton: false
            });

            // 初始化主题切换
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function () {
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('dark-mode', document.body.classList.contains('dark-mode'));
                });

                // 加载保存的主题设置
                if (localStorage.getItem('dark-mode') === 'true') {
                    document.body.classList.add('dark-mode');
                }
            }

            // 显示活动设置部分
            function showSettingsSection(sectionId) {
                const sections = document.querySelectorAll('.settings-section');
                const menuItems = document.querySelectorAll('.settings-menu-item');

                // 隐藏所有部分
                sections.forEach(section => section.classList.remove('active'));

                // 取消所有菜单项的活动状态
                menuItems.forEach(item => item.classList.remove('active'));

                // 显示选定的部分
                const section = document.getElementById(sectionId);
                if (section) section.classList.add('active');

                // 激活相应的菜单项
                const menuItem = document.querySelector(`.settings-menu-item[data-section="${sectionId}"]`);
                if (menuItem) menuItem.classList.add('active');
                
                // 根据激活的区域按需加载数据
                loadSectionDataIfNeeded(sectionId);
            }
            
            // 根据区域按需加载数据
            function loadSectionDataIfNeeded(sectionId) {
                switch(sectionId) {
                    case 'site-info':
                        if (!siteSettingsLoaded) {
                            loadSiteSettings();
                            siteSettingsLoaded = true;
                        }
                        break;
                    case 'security':
                        if (!securitySettingsLoaded) {
                            loadSecuritySettings();
                            securitySettingsLoaded = true;
                        }
                        break;
                    case 'backup':
                        if (!backupSettingsLoaded) {
                            loadBackupSettings();
                            backupSettingsLoaded = true;
                        }
                        break;
                    case 'advanced':
                        if (!advancedSettingsLoaded) {
                            loadAdvancedSettings();
                            advancedSettingsLoaded = true;
                        }
                        break;
                    case 'export':
                        // 导出区域不需要加载额外数据
                        break;
                }
            }

            // 设置菜单项点击事件
            const menuItems = document.querySelectorAll('.settings-menu-item');
            menuItems.forEach(item => {
                item.addEventListener('click', function () {
                    const section = this.getAttribute('data-section');
                    showSettingsSection(section);
                });
            });

            // 捕获URL参数，允许直接访问特定设置部分
            const urlParams = new URLSearchParams(window.location.search);
            const section = urlParams.get('section');
            if (section && document.getElementById(section)) {
                showSettingsSection(section);
            } else {
                // 默认显示首个设置部分
                showSettingsSection('site-info');
            }

            // 使用默认站点设置
            function useDefaultSiteSettings() {
                // 只在未设置值的情况下使用默认值
                const siteTitle = document.getElementById('site-title');
                const siteDescription = document.getElementById('site-description');
                const siteKeywords = document.getElementById('site-keywords');
                const footerText = document.getElementById('footer-text');
                
                if (!siteTitle.value) siteTitle.value = '笔记平台';
                if (!siteDescription.value) siteDescription.value = '一个简单易用的个人笔记管理平台';
                if (!siteKeywords.value) siteKeywords.value = '笔记,Markdown,知识管理';
                if (!footerText.value) footerText.value = '© 2023 笔记平台 - 版权所有';
            }

            // 使用默认安全设置
            function useDefaultSecuritySettings() {
                document.getElementById('allow-registration').value = '1';
                document.getElementById('session-lifetime').value = '24';
                document.getElementById('password-min-length').value = '8';
                document.getElementById('login-attempt-limit').value = '5';
                document.getElementById('lockout-duration').value = '30';
            }

            // 使用默认备份设置
            function useDefaultBackupSettings() {
                document.getElementById('auto-backup').value = '0';
                document.getElementById('backup-retention').value = '30';
                document.getElementById('backup-location').value = 'local';
            }

            // 使用默认高级设置
            function useDefaultAdvancedSettings() {
                document.getElementById('editor-default-mode').value = 'wysiwyg';
                document.getElementById('upload-max-size').value = '10';
                document.getElementById('cache-lifetime').value = '60';
                document.getElementById('language').value = 'zh-CN';

                // 将默认设置保存到localStorage中
                const defaultSettings = {
                    editorDefaultMode: 'wysiwyg',
                    uploadMaxSize: 10,
                    cacheLifetime: 60,
                    systemLanguage: 'zh-CN'
                };
                localStorage.setItem('advancedSettings', JSON.stringify(defaultSettings));
            }

            // 加载站点设置函数
            async function loadSiteSettings() {
                try {
                    if (!apiClient) {
                        throw new Error('API客户端不可用');
                    }

                    const data = await apiClient.getSiteSettings();

                    if (data && data.success) {
                        // 获取实际数据对象，可能在不同属性下
                        const settings = data.settings || data.info || data.siteInfo || {};

                        // 填充表单
                        document.getElementById('site-title').value = settings.siteTitle || settings.title || '';
                        document.getElementById('site-description').value = settings.siteDescription || settings.description || '';
                        document.getElementById('site-keywords').value = settings.siteKeywords || settings.keywords || '';
                        document.getElementById('footer-text').value = settings.footerText || '';

                        // 如果有Logo，显示预览
                        const logoUrl = settings.siteLogo || settings.logo || '';
                        if (logoUrl) {
                            const logoPreview = document.createElement('div');
                            logoPreview.className = 'logo-preview';
                            logoPreview.innerHTML = `
                                <img src="${logoUrl}" alt="站点Logo" style="max-width: 200px; margin-top: 10px;">
                            `;

                            const logoInput = document.getElementById('site-logo');
                            if (logoInput && logoInput.parentNode) {
                                logoInput.parentNode.insertBefore(logoPreview, logoInput.nextSibling);
                            }
                        }
                    } else {
                        console.warn('从API未获取到有效的站点设置，使用默认设置');
                        useDefaultSiteSettings();
                    }
                } catch (error) {
                    console.error('加载站点出错:', error);
                    useDefaultSiteSettings();
                }
            }

            // 加载安全设置函数
            async function loadSecuritySettings() {
                try {
                    // 首先检查localStorage中是否有安全设置
                    const storedSecuritySettings = localStorage.getItem('securitySettings');
                    if (storedSecuritySettings) {
                        try {
                            const parsedSettings = JSON.parse(storedSecuritySettings);

                            // 填充表单
                            document.getElementById('allow-registration').value =
                                parsedSettings.allowRegistration ? '1' : '0';
                            document.getElementById('session-lifetime').value =
                                parsedSettings.sessionLifetime || '24';
                            document.getElementById('password-min-length').value =
                                parsedSettings.passwordMinLength || '8';
                            document.getElementById('login-attempt-limit').value =
                                parsedSettings.loginAttemptLimit || '5';
                            document.getElementById('lockout-duration').value =
                                parsedSettings.lockoutDuration || '30';

                            // 已从本地存储加载，不需要从服务器加载
                            return;
                        } catch (parseError) {
                            console.error('解析本地存储的安全设置失败:', parseError);
                            // 继续从服务器加载
                        }
                    }

                    if (!apiClient) {
                        throw new Error('API客户端不可用');
                    }

                    const data = await apiClient.getSecuritySettings();

                    if (data && data.success) {
                        // 获取实际数据对象，可能在不同属性下
                        const settings = data.securitySettings || data.settings || data.info || {};

                        // 填充表单 - 添加适当的默认值
                        document.getElementById('allow-registration').value =
                            (settings.allowRegistration !== undefined) ? (settings.allowRegistration ? '1' : '0') : '1';
                        document.getElementById('session-lifetime').value =
                            settings.sessionLifetime || '24';
                        document.getElementById('password-min-length').value =
                            settings.passwordMinLength || '8';
                        document.getElementById('login-attempt-limit').value =
                            settings.loginAttemptLimit || '5';
                        document.getElementById('lockout-duration').value =
                            settings.lockoutDuration || '30';
                    } else {
                        console.warn('从API未获取到有效的安全设置，使用默认设置');
                        useDefaultSecuritySettings();
                    }
                } catch (error) {
                    console.error('加载安全设置出错:', error);
                    useDefaultSecuritySettings();
                }
            }

            // 加载备份设置函数
            async function loadBackupSettings() {
                try {
                    // 首先检查localStorage中是否有备份设置
                    const storedBackupSettings = localStorage.getItem('backupSettings');
                    if (storedBackupSettings) {
                        try {
                            const parsedSettings = JSON.parse(storedBackupSettings);

                            // 填充表单
                            document.getElementById('auto-backup').value = parsedSettings.autoBackup || '0';
                            document.getElementById('backup-retention').value = parsedSettings.backupRetention || '30';
                            document.getElementById('backup-location').value = parsedSettings.backupLocation || 'local';

                            // 已从本地存储加载，不需要从服务器加载
                            return;
                        } catch (parseError) {
                            console.error('解析本地存储的备份设置失败:', parseError);
                            // 继续从服务器加载
                        }
                    }

                    if (!apiClient) {
                        throw new Error('API客户端不可用');
                    }

                    const data = await apiClient.getBackupSettings();

                    if (data && data.success) {
                        // 获取实际数据对象
                        const settings = data.backupSettings || data.settings || {};

                        // 填充表单
                        document.getElementById('auto-backup').value = settings.autoBackup || '0';
                        document.getElementById('backup-retention').value = settings.backupRetention || '30';
                        document.getElementById('backup-location').value = settings.backupLocation || 'local';
                    } else {
                        console.warn('从API未获取到有效的备份设置，使用默认设置');
                        useDefaultBackupSettings();
                    }
                } catch (error) {
                    console.error('加载备份设置出错:', error);
                    useDefaultBackupSettings();
                }
            }

            // 加载高级设置函数
            function loadAdvancedSettings() {
                try {
                    // 从localStorage获取高级设置
                    const advancedSettingsStr = localStorage.getItem('advancedSettings');
                    if (advancedSettingsStr) {
                        const settings = JSON.parse(advancedSettingsStr);

                            // 填充表单
                        document.getElementById('editor-default-mode').value = settings.editorDefaultMode || 'wysiwyg';
                        document.getElementById('upload-max-size').value = settings.uploadMaxSize || '10';
                        document.getElementById('cache-lifetime').value = settings.cacheLifetime || '60';
                        document.getElementById('language').value = settings.systemLanguage || 'zh-CN';
                    } else {
                        // 使用默认设置
                        useDefaultAdvancedSettings();
                    }
                } catch (error) {
                    console.error('加载高级设置出错:', error);
                    // 使用默认设置
                    useDefaultAdvancedSettings();
                }
            }

            // 初始化确认退出登录函数
            window.confirmLogout = function () {
                ConfirmDialog.danger('退出登录', '确定要退出当前账号吗？', function (confirmed) {
                    if (confirmed) {
                        localStorage.removeItem('token');
                        window.location.href = 'login.html';
                    }
                });
            };

            // 绑定保存站点信息按钮的点击事件
            document.getElementById('save-site-info').addEventListener('click', async function () {
                try {
                    // 获取表单数据
                    const siteTitle = document.getElementById('site-title').value;
                    const siteDescription = document.getElementById('site-description').value;
                    const siteKeywords = document.getElementById('site-keywords').value;
                    const footerText = document.getElementById('footer-text').value;

                    // 准备请求数据
                    const formData = {
                        siteTitle,
                        siteDescription,
                        siteKeywords,
                        footerText
                    };

                    // 如果有Logo文件，则处理上传
                    const logoFile = document.getElementById('site-logo').files[0];
                    if (logoFile) {
                        // 这里可以添加文件上传逻辑
                        // 简化起见，我们先不处理Logo上传
                        ToastMessage.log('检测到Logo文件，需要单独处理上传');
                    }

                    if (!apiClient) {
                        throw new Error('API客户端不可用');
                    }

                    // 使用commpush组件发送请求
                    const data = await apiClient.updateSiteSettings(formData);

                    if (data && data.success) {
                        // 更新本地存储中的站点信息
                        // 这里我们将站点信息存储到localStorage中，以便刷新页面时能够获取到更新后的信息
                        const siteInfoToStore = {
                            title: siteTitle,
                            description: siteDescription,
                            keywords: siteKeywords,
                            footerText: footerText,
                            // 如果有Logo则保留原来的Logo
                            logo: data.siteSettings?.siteLogo || localStorage.getItem('siteLogo')
                        };

                        localStorage.setItem('siteInfo', JSON.stringify(siteInfoToStore));

                        // 显示成功消息
                        ToastMessage.success('站点设置已成功保存！');

                        // 刷新页面上的站点信息显示
                        // 如果全局函数存在，调用它们
                        if (typeof updateSiteName === 'function') {
                            updateSiteName();
                        }
                        if (typeof updateFooter === 'function') {
                            updateFooter();
                        }
                    } else {
                        throw new Error(data?.message || '更新站点设置失败');
                    }
                } catch (error) {
                    console.error('保存站点设置失败:', error);
                    ToastMessage.error('保存站点设置失败');
                    ConfirmDialog.danger('保存失败', '保存站点设置失败: ' + error.message);
                }
            });

            // 绑定保存安全设置按钮的点击事件
            document.getElementById('save-security-settings').addEventListener('click', async function () {
                try {
                    // 获取表单数据
                    const allowRegistrationValue = document.getElementById('allow-registration').value;
                    const sessionLifetimeValue = document.getElementById('session-lifetime').value;
                    const passwordMinLengthValue = document.getElementById('password-min-length').value;
                    const loginAttemptLimitValue = document.getElementById('login-attempt-limit').value;
                    const lockoutDurationValue = document.getElementById('lockout-duration').value;

                    // 准备请求数据 - 注意转换数据类型
                    const formData = {
                        allowRegistration: allowRegistrationValue === '1' || allowRegistrationValue === 'true',
                        sessionLifetime: parseInt(sessionLifetimeValue, 10),
                        passwordMinLength: parseInt(passwordMinLengthValue, 10),
                        loginAttemptLimit: parseInt(loginAttemptLimitValue, 10),
                        lockoutDuration: parseInt(lockoutDurationValue, 10)
                    };

                    if (!apiClient) {
                        throw new Error('API客户端不可用');
                    }

                    // 使用commpush组件发送请求
                    const data = await apiClient.updateSecuritySettings(formData);

                    if (data && data.success) {
                        // 显示成功消息
                        ToastMessage.success('安全设置已成功保存！');

                        // 将设置保存到localStorage中
                        localStorage.setItem('securitySettings', JSON.stringify(formData));
                    } else {
                        throw new Error(data?.message || '更新安全设置失败');
                    }
                } catch (error) {
                    console.error('保存安全设置失败:', error);
                    ToastMessage.error('保存安全设置失败');
                    ConfirmDialog.danger('保存失败', '保存安全设置失败: ' + error.message);
                }
            });

            // 绑定保存备份设置按钮的点击事件
            document.getElementById('save-backup-settings').addEventListener('click', async function () {
                try {
                    // 获取表单数据
                    const autoBackupValue = document.getElementById('auto-backup').value;
                    const backupRetentionValue = document.getElementById('backup-retention').value;
                    const backupLocationValue = document.getElementById('backup-location').value;

                    // 准备请求数据 - 注意转换数据类型
                    const formData = {
                        autoBackup: parseInt(autoBackupValue, 10),
                        backupRetention: parseInt(backupRetentionValue, 10),
                        backupLocation: backupLocationValue
                    };

                    if (!apiClient) {
                        throw new Error('API客户端不可用');
                    }

                    // 使用commpush组件发送请求
                    const data = await apiClient.updateBackupSettings(formData);

                    if (data && data.success) {
                        // 显示成功消息
                        ToastMessage.success('备份设置已成功保存！');

                        // 将设置保存到localStorage中
                        localStorage.setItem('backupSettings', JSON.stringify(formData));
                    } else {
                        throw new Error(data?.message || '更新备份设置失败');
                    }
                } catch (error) {
                    console.error('保存备份设置失败:', error);
                    ToastMessage.error('保存备份设置失败');
                    ConfirmDialog.danger('保存失败', '保存备份设置失败: ' + error.message);
                }
            });

            // 绑定保存高级设置按钮的点击事件
            document.getElementById('save-advanced-settings').addEventListener('click', function () {
                try {
                    // 获取表单数据
                    const editorDefaultMode = document.getElementById('editor-default-mode').value;
                    const uploadMaxSize = document.getElementById('upload-max-size').value;
                    const cacheLifetime = document.getElementById('cache-lifetime').value;
                    const systemLanguage = document.getElementById('language').value;

                    // 准备数据 - 注意转换数据类型
                    const settings = {
                        editorDefaultMode,
                        uploadMaxSize: parseInt(uploadMaxSize, 10),
                        cacheLifetime: parseInt(cacheLifetime, 10),
                        systemLanguage
                    };

                    // 将设置保存到localStorage中
                    localStorage.setItem('advancedSettings', JSON.stringify(settings));

                        // 显示成功消息
                        ToastMessage.success('高级设置已成功保存！');
                } catch (error) {
                    console.error('保存高级设置失败:', error);
                    ToastMessage.error('保存高级设置失败');
                    ConfirmDialog.danger('保存失败', '保存高级设置失败: ' + error.message);
                }
            });

            // 添加导入笔记功能
            (function() {
                // 获取导入相关元素
            const importDropzone = document.getElementById('import-dropzone');
            const importFileInput = document.getElementById('import-file-input');
            const importSelectBtn = document.getElementById('import-select-btn');
            const importFileList = document.getElementById('import-file-list');
            const importFiles = document.getElementById('import-files');
            const importClearBtn = document.getElementById('import-clear-btn');
            const importUploadBtn = document.getElementById('import-upload-btn');
            const importProgress = document.getElementById('import-progress');
            const importProgressBar = document.getElementById('import-progress-bar');
            const importStatus = document.getElementById('import-status');
            const importResults = document.getElementById('import-results');
            const importSuccessCount = document.getElementById('import-success-count');
            const importFailedCount = document.getElementById('import-failed-count');
            const importErrorList = document.getElementById('import-error-list');
            const importErrors = document.getElementById('import-errors');
            const importDoneBtn = document.getElementById('import-done-btn');
                const importDropzoneContent = document.querySelector('.import-dropzone-content');

                // 存储选择的文件
            let selectedFiles = [];

                // 绑定点击选择文件按钮事件
                if (importSelectBtn) {
                    importSelectBtn.addEventListener('click', function() {
                    importFileInput.click();
                });
                }

                // 绑定文件选择事件
                if (importFileInput) {
                    importFileInput.addEventListener('change', function(e) {
                    handleFiles(e.target.files);
                });
                }

                // 绑定拖放事件
                if (importDropzone) {
                    importDropzone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    importDropzone.classList.add('drag-over');
                });

                    importDropzone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    importDropzone.classList.remove('drag-over');
                });

                    importDropzone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    importDropzone.classList.remove('drag-over');
                        handleFiles(e.dataTransfer.files);
                    });
                }

                // 处理文件选择或拖放的文件
                function handleFiles(files) {
                    // 过滤出.md文件
                    const markdownFiles = Array.from(files).filter(file => 
                    file.name.toLowerCase().endsWith('.md')
                );

                    if (markdownFiles.length === 0) {
                        ToastMessage.error('请选择Markdown文件(.md)');
                    return;
                }

                    // 限制文件数量
                    const maxFiles = 20;
                    if (selectedFiles.length + markdownFiles.length > maxFiles) {
                        ToastMessage.warning(`一次最多只能导入${maxFiles}个文件`);
                        return;
                    }

                    // 添加文件到列表
                    markdownFiles.forEach(file => {
                        // 检查是否已添加过相同文件
                        if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                            selectedFiles.push(file);
                        }
                    });

                    // 更新UI
                updateFileList();
            }

                // 更新文件列表UI
            function updateFileList() {
                    // 清空当前列表
                importFiles.innerHTML = '';

                    // 添加文件到列表
                selectedFiles.forEach((file, index) => {
                        const fileSize = formatFileSize(file.size);
                        const fileItem = document.createElement('li');
                        fileItem.classList.add('file-item');
                        fileItem.innerHTML = `
                            <span class="file-name">${file.name}</span>
                            <span class="file-size">${fileSize}</span>
                            <button class="file-remove" data-index="${index}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        importFiles.appendChild(fileItem);
                    });

                    // 绑定移除文件按钮事件
                    const removeButtons = importFiles.querySelectorAll('.file-remove');
                    removeButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            const index = parseInt(this.getAttribute('data-index'), 10);
                        selectedFiles.splice(index, 1);
                        updateFileList();
                    });
                });

                    // 显示或隐藏文件列表
                if (selectedFiles.length > 0) {
                    importFileList.style.display = 'block';
                        importDropzoneContent.style.display = 'none';
                } else {
                    importFileList.style.display = 'none';
                        importDropzoneContent.style.display = 'flex';
                    }
                }

                // 格式化文件大小
                function formatFileSize(bytes) {
                    if (bytes < 1024) {
                        return bytes + ' B';
                    } else if (bytes < 1024 * 1024) {
                        return (bytes / 1024).toFixed(2) + ' KB';
                    } else {
                        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
                    }
                }

                // 绑定清空按钮事件
                if (importClearBtn) {
                    importClearBtn.addEventListener('click', function() {
                selectedFiles = [];
                updateFileList();
                    });
                }

                // 绑定开始导入按钮事件
                if (importUploadBtn) {
                    importUploadBtn.addEventListener('click', function() {
                        startImport();
                    });
                }

                // 绑定完成按钮事件
                if (importDoneBtn) {
                    importDoneBtn.addEventListener('click', function() {
                        resetImportUI();
                    });
            }

            // 重置导入UI
            function resetImportUI() {
                importResults.style.display = 'none';
                    importDropzoneContent.style.display = 'flex';
                importFileList.style.display = 'none';
                importProgress.style.display = 'none';
                    selectedFiles = [];
                }

                // 开始导入文件
                async function startImport() {
                    if (selectedFiles.length === 0) {
                        ToastMessage.error('请先选择要导入的Markdown文件');
                        return;
                    }

                    // 获取API客户端
                    const apiClient = window.commpush || window.api;
                    if (!apiClient || typeof apiClient.saveMarkdown !== 'function') {
                        ToastMessage.error('API客户端不可用，无法导入笔记');
                            return;
                        }

                    // 显示进度UI
                    importFileList.style.display = 'none';
                    importProgress.style.display = 'block';
                    
                    let successCount = 0;
                    let failedCount = 0;
                    const errors = [];

                    // 处理每个文件
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const file = selectedFiles[i];
                        const progressPercent = (i / selectedFiles.length) * 100;
                        
                        // 更新进度条
                        importProgressBar.style.width = progressPercent + '%';
                        importStatus.textContent = `正在导入 ${i+1}/${selectedFiles.length}: ${file.name}`;

                        try {
                            // 读取文件内容
                            const content = await readFileAsText(file);
                            
                            // 尝试从内容中提取标题（第一行去掉#号后的内容）
                            let title;
                            let processedContent = content;
                            const titleMatch = content.match(/^#\s+(.+)$/m);
                            
                            if (titleMatch) {
                                title = titleMatch[1];
                                // 删除内容中的标题行，避免重复
                                processedContent = content.replace(/^#\s+(.+)$/m, '').trim();
                                // 如果删除标题行后内容前面有空行，保留一个空行
                                if (processedContent.startsWith('\n\n')) {
                                    processedContent = '\n' + processedContent.substring(2);
                                }
                            } else {
                                // 如果内容中没有标题，则从文件名中提取，去掉.md扩展名
                                title = file.name.replace(/\.md$/i, '');
                            }
                            
                            // 使用时间戳和标题创建唯一的文件名
                            const timestamp = new Date().getTime();
                            const sanitizedTitle = title.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                            const fileName = `${timestamp}_${sanitizedTitle}`;
                            
                            // 保存Markdown文件，显式传递提取的标题
                            const response = await apiClient.saveMarkdown(fileName, processedContent, title);
                            
                            if (response && response.success) {
                                successCount++;
                                
                                // 如果不在localStorage中添加记录，saveMarkdown API会处理这部分
                                // 可以选择性更新本地缓存
                                try {
                                    const notes = JSON.parse(localStorage.getItem('notes') || '[]');
                                    const noteData = {
                                        id: response.note._id,
                                        _id: response.note._id,
                                        title: title,
                                        content: processedContent,
                                        fileName: fileName,
                                        updatedAt: new Date().toISOString(),
                                        createdAt: new Date().toISOString(),
                                        inTrash: false,
                                        isStarred: false
                                    };
                                    
                                    // 检查是否已存在，如果存在则替换
                                    const existingIndex = notes.findIndex(n => n._id === noteData._id);
                                    if (existingIndex !== -1) {
                                        notes[existingIndex] = noteData;
                                } else {
                                        notes.push(noteData);
                                    }
                                    
                                    localStorage.setItem('notes', JSON.stringify(notes));
                                } catch (storageError) {
                                    console.error('更新本地存储失败:', storageError);
                                }
                            } else {
                                failedCount++;
                                errors.push(`${file.name}: ${response.message || '保存笔记失败'}`);
                            }
                        } catch (error) {
                            failedCount++;
                            errors.push(`${file.name}: ${error.message || '读取文件失败'}`);
                        }

                            // 短暂延迟以避免UI卡顿
                            await new Promise(resolve => setTimeout(resolve, 10));
                        }

                    // 更新进度条至100%
                    importProgressBar.style.width = '100%';
                    importStatus.textContent = '导入完成';

                    // 显示结果
                    importProgress.style.display = 'none';
                    importResults.style.display = 'block';
                    importSuccessCount.querySelector('span').textContent = `成功：${successCount}个笔记`;
                    importFailedCount.querySelector('span').textContent = `失败：${failedCount}个笔记`;

                    // 显示错误详情
                    if (errors.length > 0) {
                        importErrorList.style.display = 'block';
                        importErrors.innerHTML = '';
                        errors.forEach(error => {
                            const li = document.createElement('li');
                            li.textContent = error;
                            importErrors.appendChild(li);
                        });
                    } else {
                        importErrorList.style.display = 'none';
                    }
                }

                // 读取文件内容
                function readFileAsText(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            resolve(e.target.result);
                        };
                        reader.onerror = function(e) {
                            reject(new Error('读取文件失败'));
                        };
                        reader.readAsText(file);
                    });
                }
            })();

            // 立即添加导出功能
            (function() {
                const exportNotesBtn = document.getElementById('export-notes');
                const exportStatus = document.getElementById('export-status');

                if (exportNotesBtn) {
                    exportNotesBtn.addEventListener('click', exportNotes);
                }

            // 加载JSZip库
            async function loadJSZip() {
                return new Promise((resolve, reject) => {
                    if (window.JSZip) {
                        resolve(window.JSZip);
                        return;
                    }

                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                    script.onload = () => resolve(window.JSZip);
                    script.onerror = () => reject(new Error('无法加载JSZip库'));
                    document.head.appendChild(script);
                });
            }

            // 将HTML转换为Markdown
            function htmlToMarkdown(html) {
                if (!html) return '';

                // 创建临时DOM元素来解析HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                // 递归处理节点
                function processNode(node, level = 0) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        return node.textContent;
                    }

                    if (node.nodeType !== Node.ELEMENT_NODE) {
                        return '';
                    }

                    let result = '';
                    const nodeName = node.nodeName.toLowerCase();

                    // 处理不同类型的HTML元素
                    switch (nodeName) {
                        case 'h1':
                            return `# ${getTextContent(node)}\n\n`;
                        case 'h2':
                            return `## ${getTextContent(node)}\n\n`;
                        case 'h3':
                            return `### ${getTextContent(node)}\n\n`;
                        case 'h4':
                            return `#### ${getTextContent(node)}\n\n`;
                        case 'h5':
                            return `##### ${getTextContent(node)}\n\n`;
                        case 'h6':
                            return `###### ${getTextContent(node)}\n\n`;
                        case 'p':
                            return `${processChildren(node)}\n\n`;
                        case 'strong':
                        case 'b':
                            return `**${processChildren(node)}**`;
                        case 'em':
                        case 'i':
                            return `*${processChildren(node)}*`;
                        case 'a':
                            return `[${processChildren(node)}](${node.getAttribute('href') || ''})`;
                        case 'img':
                            return `![${node.getAttribute('alt') || ''}](${node.getAttribute('src') || ''})`;
                        case 'code':
                            if (node.parentNode && node.parentNode.nodeName.toLowerCase() === 'pre') {
                                // 这是代码块的一部分，由pre处理
                                return processChildren(node);
                            }
                            return `\`${processChildren(node)}\``;
                        case 'pre':
                            return `\`\`\`\n${getTextContent(node)}\n\`\`\`\n\n`;
                        case 'ul':
                        case 'ol':
                            return processChildren(node) + '\n';
                        case 'li':
                            return `- ${processChildren(node)}\n`;
                        case 'blockquote':
                            return `> ${processChildren(node)}\n\n`;
                        case 'br':
                            return '\n';
                        case 'div':
                            return processChildren(node) + (level === 0 ? '\n\n' : '');
                        default:
                            return processChildren(node);
                    }
                }

                function processChildren(node) {
                    let result = '';
                    for (const child of node.childNodes) {
                        result += processNode(child, 1);
                    }
                    return result;
                }

                function getTextContent(node) {
                    return node.textContent.trim();
                }

                let markdown = '';
                for (const child of tempDiv.childNodes) {
                    markdown += processNode(child);
                }

                return markdown.trim();
            }

            // 创建有效的文件名
            function makeValidFileName(name) {
                return name.replace(/[\\/:*?"<>|]/g, '_');
            }

                // 导出笔记主函数
                async function exportNotes() {
                    try {
                        // 显示状态
                    exportStatus.textContent = '正在准备导出...';
                        exportStatus.style.display = 'inline';
                        exportNotesBtn.disabled = true;

                        // 获取所有笔记
                        let notes = [];

                        // 尝试从API获取笔记
                        const apiClient = window.commpush || window.api;
                        if (apiClient && typeof apiClient.getNotes === 'function') {
                            try {
                                const response = await apiClient.getNotes();
                                if (response && Array.isArray(response.notes)) {
                                    notes = response.notes;
                                } else if (Array.isArray(response)) {
                                    notes = response;
                                }
                            } catch (apiError) {
                                console.error('从API获取笔记失败:', apiError);
                                // 回退到本地存储
                                const notesStr = localStorage.getItem('notes') || '[]';
                                notes = JSON.parse(notesStr);
                            }
                        } else {
                            // 回退到本地存储
                            const notesStr = localStorage.getItem('notes') || '[]';
                            notes = JSON.parse(notesStr);
                        }

                        // 过滤掉已删除的笔记
                        notes = notes.filter(note => !note.trash && !note.inTrash);

                        // 检查是否有笔记可导出
                        if (notes.length === 0) {
                            exportStatus.textContent = '没有可导出的笔记';
                            setTimeout(() => {
                                exportStatus.style.display = 'none';
                                exportNotesBtn.disabled = false;
                            }, 3000);
                            return;
                        }

                        exportStatus.textContent = `正在准备 ${notes.length} 个笔记进行导出...`;

                        // 创建ZIP文件
                        const JSZip = window.JSZip || await loadJSZip();
                        const zip = new JSZip();
                        
                        // 为每个笔记创建一个文件
                        for (let i = 0; i < notes.length; i++) {
                            const note = notes[i];
                            
                            // 更新进度
                            exportStatus.textContent = `正在处理笔记... (${i + 1}/${notes.length})`;

                            // 转换笔记内容为Markdown
                            let content = htmlToMarkdown(note.content || note.contentData || '');
                            
                            // 无论内容如何，都始终将笔记标题添加到第一行
                            content = `# ${note.title || 'Untitled'}\n\n${content}`;

                            // 使用简单的时间戳作为文件名
                            const timestamp = Date.now() + i; // 添加索引以确保唯一性
                            const fileName = `${timestamp}.md`;

                            // 添加到ZIP
                            zip.file(fileName, content);
                            
                            // 短暂延迟以避免UI卡顿
                            await new Promise(resolve => setTimeout(resolve, 10));
                        }

                        // 生成并下载zip文件
                        exportStatus.textContent = '正在生成ZIP文件...';
                        const blob = await zip.generateAsync({
                            type: 'blob',
                            compression: 'DEFLATE',
                            compressionOptions: { level: 6 }
                        });
                        
                        const url = URL.createObjectURL(blob);
                                    const link = document.createElement('a');
                                    link.href = url;
                        link.download = `notes_export_${new Date().toISOString().split('T')[0]}.zip`;
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);

                        // 释放URL
                        setTimeout(() => URL.revokeObjectURL(url), 5000);

                        // 完成
                        exportStatus.textContent = '导出完成!';
                        setTimeout(() => {
                            exportStatus.style.display = 'none';
                            exportNotesBtn.disabled = false;
                        }, 3000);
                    } catch (error) {
                        console.error('导出笔记时出错:', error);
                        exportStatus.textContent = '导出失败: ' + (error.message || '未知错误');
                        setTimeout(() => {
                            exportStatus.style.display = 'none';
                            exportNotesBtn.disabled = false;
                        }, 5000);
                    }
                }
            })();
        });
    </script>
</body>

</html>
